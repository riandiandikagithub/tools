sources:
  docker_logs:
    type: docker_logs
    docker_host: unix:///var/run/docker.sock
    exclude_containers:
      - grafana
      - loki
      - prometheus
      - tempo

transforms:
  parse_and_enrich:
    type: remap
    inputs: [docker_logs]
    source: |
      if is_string(.message) {
        parsed, err = parse_json(.message)
        if err == null {
          . = merge!(., parsed)
        }
      }

      if !exists(.service) {
        .service = "bp-master-data-svc"
      }

      if exists(.level) {
        .level = downcase!(.level)
      } else {
        .level = "info"
      }

      # ðŸ”‘ FIX UTAMA
      if exists(.trace_id) {
        .trace_id = to_string!(.trace_id)
      } else if exists(.TRACE_ID) {
        .trace_id = to_string!(.TRACE_ID)
      } else {
        .trace_id = "no-trace"
      }

sinks:
  loki:
    type: loki
    inputs: [parse_and_enrich]
    endpoint: http://loki:3100

    encoding:
      codec: json

    labels:
      service: "{{ service }}"
      level: "{{ level }}"
      trace_id: "{{ trace_id }}"
      container: "{{ container_name }}"
      stream: "{{ stream }}"
