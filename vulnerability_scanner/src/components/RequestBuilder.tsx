import React, { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Separator } from '@/components/ui/separator';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Switch } from '@/components/ui/switch';
import { toast } from '@/hooks/use-toast';
import { Copy, Download, FileText, Image, Trash2, Plus, Upload, Play, Settings, Shield, Code, Zap } from 'lucide-react';
import { RequestConfig } from '@/types/vulnerability';
import { CurlParser, RequestFormatter } from '@/utils/curlParser';

interface RequestBuilderProps {
  config: RequestConfig;
  onChange: (config: RequestConfig) => void;
  onSend: () => void;
  isLoading?: boolean;
}

export const RequestBuilder: React.FC<RequestBuilderProps> = ({
  config,
  onChange,
  onSend,
  isLoading = false
}) => {
  const [curlInput, setCurlInput] = useState('');
  const [newHeaderKey, setNewHeaderKey] = useState('');
  const [newHeaderValue, setNewHeaderValue] = useState('');
  const [newParamKey, setNewParamKey] = useState('');
  const [newParamValue, setNewParamValue] = useState('');

  const handleCurlImport = () => {
    try {
      const imported = CurlParser.importFromCurl(curlInput);
      onChange(imported.parsed);
      setCurlInput('');
      toast({
        title: "✅ cURL Imported",
        description: "Request configuration has been imported successfully",
      });
    } catch (error) {
      toast({
        title: "❌ Import Failed",
        description: "Invalid cURL command format",
        variant: "destructive",
      });
    }
  };

  const addHeader = () => {
    if (newHeaderKey && newHeaderValue) {
      onChange({
        ...config,
        headers: { ...config.headers, [newHeaderKey]: newHeaderValue }
      });
      setNewHeaderKey('');
      setNewHeaderValue('');
    }
  };

  const removeHeader = (key: string) => {
    const newHeaders = { ...config.headers };
    delete newHeaders[key];
    onChange({ ...config, headers: newHeaders });
  };

  const addParam = () => {
    if (newParamKey && newParamValue) {
      onChange({
        ...config,
        params: { ...config.params, [newParamKey]: newParamValue }
      });
      setNewParamKey('');
      setNewParamValue('');
    }
  };

  const removeParam = (key: string) => {
    const newParams = { ...config.params };
    delete newParams[key];
    onChange({ ...config, params: newParams });
  };

  const formatBody = () => {
    if (!config.body) return;
    
    let formatted = '';
    switch (config.body.type) {
      case 'json':
        formatted = RequestFormatter.formatJson(config.body.content);
        break;
      case 'xml':
        formatted = RequestFormatter.formatXml(config.body.content);
        break;
      default:
        formatted = config.body.content;
    }
    
    onChange({
      ...config,
      body: { ...config.body, content: formatted }
    });
  };

  const minifyBody = () => {
    if (!config.body) return;
    
    let minified = '';
    switch (config.body.type) {
      case 'json':
        minified = RequestFormatter.minifyJson(config.body.content);
        break;
      default:
        minified = config.body.content;
    }
    
    onChange({
      ...config,
      body: { ...config.body, content: minified }
    });
  };

  return (
    <Card className="h-full">
      <CardHeader className="pb-4">
        <div className="flex items-center justify-between">
          <CardTitle className="flex items-center gap-2">
            <Code className="h-5 w-5 text-primary" />
            Request Builder
          </CardTitle>
          <Button 
            onClick={onSend} 
            disabled={!config.url || isLoading}
            className="gradient-primary"
          >
            {isLoading ? (
              <>
                <Zap className="h-4 w-4 mr-2 animate-spin" />
                Scanning...
              </>
            ) : (
              <>
                <Play className="h-4 w-4 mr-2" />
                Send Request
              </>
            )}
          </Button>
        </div>
      </CardHeader>
      
      <CardContent className="space-y-6">
        {/* cURL Import */}
        <div className="space-y-3">
          <Label className="text-sm font-medium">Import from cURL</Label>
          <div className="flex gap-2">
            <Textarea
              placeholder="curl -X GET 'https://api.example.com/users' -H 'Authorization: Bearer token'"
              value={curlInput}
              onChange={(e) => setCurlInput(e.target.value)}
              className="min-h-[80px] font-mono text-sm"
            />
            <Button 
              onClick={handleCurlImport} 
              disabled={!curlInput}
              variant="outline"
              size="sm"
            >
              <Upload className="h-4 w-4" />
            </Button>
          </div>
        </div>

        <Separator />

        {/* URL and Method */}
        <div className="grid grid-cols-12 gap-3">
          <div className="col-span-3">
            <Label>Method</Label>
            <Select 
              value={config.method} 
              onValueChange={(value) => onChange({ ...config, method: value as any })}
            >
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="GET">GET</SelectItem>
                <SelectItem value="POST">POST</SelectItem>
                <SelectItem value="PUT">PUT</SelectItem>
                <SelectItem value="DELETE">DELETE</SelectItem>
                <SelectItem value="PATCH">PATCH</SelectItem>
                <SelectItem value="HEAD">HEAD</SelectItem>
                <SelectItem value="OPTIONS">OPTIONS</SelectItem>
              </SelectContent>
            </Select>
          </div>
          <div className="col-span-9">
            <Label>URL</Label>
            <Input
              placeholder="https://api.example.com/endpoint"
              value={config.url}
              onChange={(e) => onChange({ ...config, url: e.target.value })}
            />
          </div>
        </div>

        <Tabs defaultValue="params" className="w-full">
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="params">Params</TabsTrigger>
            <TabsTrigger value="headers">Headers</TabsTrigger>
            <TabsTrigger value="auth">Auth</TabsTrigger>
            <TabsTrigger value="body">Body</TabsTrigger>
          </TabsList>

          {/* Parameters Tab */}
          <TabsContent value="params" className="space-y-4">
            <div className="flex gap-2">
              <Input
                placeholder="Key"
                value={newParamKey}
                onChange={(e) => setNewParamKey(e.target.value)}
              />
              <Input
                placeholder="Value"
                value={newParamValue}
                onChange={(e) => setNewParamValue(e.target.value)}
              />
              <Button onClick={addParam} size="sm" variant="outline">
                <Plus className="h-4 w-4" />
              </Button>
            </div>
            
            <ScrollArea className="h-32">
              <div className="space-y-2">
                {Object.entries(config.params).map(([key, value]) => (
                  <div key={key} className="flex items-center gap-2 p-2 bg-muted rounded">
                    <Badge variant="outline">{key}</Badge>
                    <span className="flex-1 text-sm">{value}</span>
                    <Button 
                      onClick={() => removeParam(key)} 
                      size="sm" 
                      variant="ghost"
                    >
                      <Trash2 className="h-3 w-3" />
                    </Button>
                  </div>
                ))}
              </div>
            </ScrollArea>
          </TabsContent>

          {/* Headers Tab */}
          <TabsContent value="headers" className="space-y-4">
            <div className="flex gap-2">
              <Input
                placeholder="Header Name"
                value={newHeaderKey}
                onChange={(e) => setNewHeaderKey(e.target.value)}
              />
              <Input
                placeholder="Header Value"
                value={newHeaderValue}
                onChange={(e) => setNewHeaderValue(e.target.value)}
              />
              <Button onClick={addHeader} size="sm" variant="outline">
                <Plus className="h-4 w-4" />
              </Button>
            </div>
            
            <ScrollArea className="h-32">
              <div className="space-y-2">
                {Object.entries(config.headers).map(([key, value]) => (
                  <div key={key} className="flex items-center gap-2 p-2 bg-muted rounded">
                    <Badge variant="outline">{key}</Badge>
                    <span className="flex-1 text-sm font-mono">{value}</span>
                    <Button 
                      onClick={() => removeHeader(key)} 
                      size="sm" 
                      variant="ghost"
                    >
                      <Trash2 className="h-3 w-3" />
                    </Button>
                  </div>
                ))}
              </div>
            </ScrollArea>
          </TabsContent>

          {/* Authentication Tab */}
          <TabsContent value="auth" className="space-y-4">
            <div>
              <Label>Auth Type</Label>
              <Select 
                value={config.auth?.type || 'none'} 
                onValueChange={(value) => onChange({ 
                  ...config, 
                  auth: { ...config.auth, type: value as any } 
                })}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="none">No Auth</SelectItem>
                  <SelectItem value="bearer">Bearer Token</SelectItem>
                  <SelectItem value="basic">Basic Auth</SelectItem>
                  <SelectItem value="api-key">API Key</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {config.auth?.type === 'bearer' && (
              <div>
                <Label>Token</Label>
                <Input
                  type="password"
                  placeholder="Bearer token"
                  value={config.auth.token || ''}
                  onChange={(e) => onChange({
                    ...config,
                    auth: { ...config.auth, token: e.target.value }
                  })}
                />
              </div>
            )}

            {config.auth?.type === 'basic' && (
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <Label>Username</Label>
                  <Input
                    placeholder="Username"
                    value={config.auth.username || ''}
                    onChange={(e) => onChange({
                      ...config,
                      auth: { ...config.auth, username: e.target.value }
                    })}
                  />
                </div>
                <div>
                  <Label>Password</Label>
                  <Input
                    type="password"
                    placeholder="Password"
                    value={config.auth.password || ''}
                    onChange={(e) => onChange({
                      ...config,
                      auth: { ...config.auth, password: e.target.value }
                    })}
                  />
                </div>
              </div>
            )}

            {config.auth?.type === 'api-key' && (
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <Label>Key</Label>
                  <Input
                    placeholder="X-API-Key"
                    value={config.auth.apiKey || ''}
                    onChange={(e) => onChange({
                      ...config,
                      auth: { ...config.auth, apiKey: e.target.value }
                    })}
                  />
                </div>
                <div>
                  <Label>Value</Label>
                  <Input
                    type="password"
                    placeholder="API Key Value"
                    value={config.auth.apiValue || ''}
                    onChange={(e) => onChange({
                      ...config,
                      auth: { ...config.auth, apiValue: e.target.value }
                    })}
                  />
                </div>
              </div>
            )}
          </TabsContent>

          {/* Body Tab */}
          <TabsContent value="body" className="space-y-4">
            <div className="flex items-center justify-between">
              <div>
                <Label>Body Type</Label>
                <Select 
                  value={config.body?.type || 'raw'} 
                  onValueChange={(value) => onChange({
                    ...config,
                    body: { 
                      type: value as any, 
                      content: config.body?.content || '' 
                    }
                  })}
                >
                  <SelectTrigger className="w-32">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="raw">Raw</SelectItem>
                    <SelectItem value="json">JSON</SelectItem>
                    <SelectItem value="xml">XML</SelectItem>
                    <SelectItem value="form">Form</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              
              <div className="flex gap-2">
                <Button onClick={formatBody} size="sm" variant="outline">
                  Format
                </Button>
                <Button onClick={minifyBody} size="sm" variant="outline">
                  Minify
                </Button>
              </div>
            </div>

            <Textarea
              placeholder={
                config.body?.type === 'json' ? '{\n  "key": "value"\n}' :
                config.body?.type === 'xml' ? '<?xml version="1.0"?>\n<root></root>' :
                config.body?.type === 'form' ? 'key1=value1&key2=value2' :
                'Raw body content'
              }
              value={config.body?.content || ''}
              onChange={(e) => onChange({
                ...config,
                body: { 
                  type: config.body?.type || 'raw', 
                  content: e.target.value 
                }
              })}
              className="min-h-[120px] font-mono text-sm"
            />
          </TabsContent>
        </Tabs>
      </CardContent>
    </Card>
  );
};